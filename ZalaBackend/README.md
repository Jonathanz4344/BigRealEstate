# Zala Backend (FastAPI)

Backend service for the **Zala** project, built with [FastAPI](https://fastapi.tiangolo.com/), [Uvicorn](https://www.uvicorn.org/), and [Pydantic v2](https://docs.pydantic.dev/).

---

## Requirements

- **Python 3.13 or higher** (tested with Python 3.13)
- **pip** for dependency management

---

## Project Structure

```text
ZalaBackend/
├── app/
│   ├── data/
│   │   └── mock_properties.json           # Mock property inventory used by search endpoints
│   ├── db/
│   │   ├── crud/                          # CRUD helpers (addresses, leads, campaigns, etc.)
│   │   ├── schema.sql                     # Core PostgreSQL schema
│   │   ├── data.sql                       # Seed data used during development
│   │   └── session.py                     # SQLAlchemy session configuration
│   ├── external_api/                      # Client wrappers for Google Places, RapidAPI, ToLeads
│   ├── models/                            # SQLAlchemy ORM models
│   ├── routes/                            # FastAPI routers (users, leads, campaigns, …)
│   ├── schemas/                           # Pydantic request/response models
│   ├── utils/                             # Utility helpers (e.g. geocoding)
│   └── main.py                            # FastAPI application entry point
├── scripts/                               # Helper scripts (data loading, tooling)
├── tests/                                 # Unit and integration tests
├── API_ROUTES_README.md                   # Endpoint documentation for frontend consumers
├── requirements.txt                       # Python dependencies
├── package.json / package-lock.json       # Frontend tooling configuration (if needed)
├── .env                                   # Local environment variables (not tracked)
├── __init__.py                            # Allows running `python -m app`
└── README.md                              # This guide
```

For a detailed endpoint catalogue, see `API_ROUTES_README.md`.

---

## Local Environment Setup (Windows)

1. **Verify Python installation**
   ```powershell
   py --version
   ```
   Ensure the reported version is **3.13+**.

2. **Install dependencies**
   ```powershell
   py -m pip install -r requirements.txt
   ```

3. **Configure environment variables**
   - Duplicate `.env.example` to `.env` if available, otherwise create `.env`.
   - For geocoding features, set `GOOGLE_API_KEY=<your_api_key>`.

---

## Running the API

From the project root (`ZalaBackend/`):

```powershell
py -m uvicorn app.main:app --reload
```

- API base URL: http://127.0.0.1:8000
- Interactive docs (Swagger): http://127.0.0.1:8000/docs
- Alternate docs (ReDoc): http://127.0.0.1:8000/redoc

If you start inside the `app/` directory, adjust the module path:

```powershell
py -m uvicorn main:app --reload
```

Use `--reload` during development to auto-restart on file changes.

---

## Testing

1. Start the server as shown above.
2. Visit the autogenerated docs to exercise endpoints:
   - Swagger UI: http://127.0.0.1:8000/docs
   - ReDoc: http://127.0.0.1:8000/redoc

You can also craft requests with tools such as `httpie`, `curl`, or Postman.

---

## Development Notes

- Environment-specific configuration belongs in `.env`; keep secrets out of version control.
- The `/api` prefix is applied to every router included in `app/main.py`.
- When linking related entities (e.g., lead ↔ property), prefer the dedicated link/unlink endpoints rather than embedding IDs in create requests.
- Keep `API_ROUTES_README.md` up to date when you add or change endpoints so the UI team has accurate guidance.

---

## ENV & External Services

Some features rely on external APIs (e.g., Google Maps). To enable them:

1. Create or select a project at https://console.cloud.google.com/.
2. Enable the **Geocoding API** (and any other required services).
3. Generate an API key under **APIs & Services -> Credentials**.
4. Add the key to `.env` as `GOOGLE_API_KEY=...`.

### Google Sign-In (OAuth 2.0)

1. In Google Cloud Console, open **APIs & Services -> OAuth consent screen**, choose the appropriate user type, and complete the app details (support email, scopes, test users if needed). Publish or save the consent screen when finished.
2. Go to **APIs & Services -> Credentials**, click **Create Credentials -> OAuth client ID**, select **Web application**, and add your local dev origins (`http://localhost:3000`, `http://127.0.0.1:3000`, `http://localhost:5173`, `http://127.0.0.1:5173`  plus your FastAPI host if you will initiate flows from Swagger). Add redirect URIs such as `http://localhost:3000/auth/google/callback` and `http://localhost:8000/docs/oauth2-redirect`.
3. Copy the generated *Client ID* and *Client Secret* into `.env`:
   ```ini
   GOOGLE_CLIENT_ID=...
   GOOGLE_CLIENT_SECRET=...
   ```
   Restart the FastAPI server after updating environment variables.
4. Frontend clients should obtain a Google ID token via the Google Identity Services JavaScript SDK and send it to `POST /api/login/google`. The backend will verify the token and return the associated `UserPublic`.
5. FRONTEND .ENV NEEDS 
   ```ini
   VITE_GOOGLE_CLIENT_ID=...

   ```


Restart the server after updating `.env` so changes take effect.

